<!doctype html>

<head>
	<title> piano roll in the browser wow </title>
	<script src='https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js'></script>
	<script src='scripts/classes.js'></script>
	<script src='scripts/globals.js'></script>
	
	
	<!-- stuff needed for contextMenu -->
	<link rel="stylesheet" href="https://swisnl.github.io/jQuery-contextMenu/css/screen.css" type="text/css"/>
    <!-- <link rel="stylesheet" href="https://swisnl.github.io/jQuery-contextMenu/css/theme.css" type="text/css"/> -->
    <!-- <link rel="stylesheet" href="https://swisnl.github.io/jQuery-contextMenu/css/theme-fixes.css" type="text/css"/> -->
    <!-- <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.4/styles/github.min.css"> -->
    <link href="https://swisnl.github.io/jQuery-contextMenu/dist/jquery.contextMenu.css" rel="stylesheet" type="text/css" />
    <script src="https://swisnl.github.io/jQuery-contextMenu/dist/jquery.contextMenu.js" type="text/javascript"></script>
    <script src="https://swisnl.github.io/jQuery-contextMenu/dist/jquery.ui.position.min.js" type="text/javascript"></script>
    <script src="https://swisnl.github.io/jQuery-contextMenu/js/main.js" type="text/javascript"></script>

	<!--
	<script src='build_grid.js'></script>
	<script src='dom_modification.js'></script>
	<script src='play_functionality.js'></script>
	-->
	<meta charset='utf-8'>
</head>

<style>
	html{
		font-family: Arial;
	}
	
	/* override padding-bottom from contextMenu/css/screen.css */
	html body{
		padding-bottom: 0;
	}
	
	table, tr, td{
		border: 1px solid #000;
	}

	#piano{
		display: inline-block;
		
		/* this is important for letting the grid expand horizontally */
		white-space: nowrap;
	}
	
	#wavetypeLabel, #tempoLabel{
		font-family: 'arial', 'gothic ms';
		font-size: 14px;
		padding-left: 10px;
	}
	
	#changeTempo{
		width: 40px;
	}
	
	#title{
		margin: 0;
	}
	
	ul{
		padding: 0;
		margin: 0;
	}
	
	#toolbar li{
		list-style-type: none;
		display: inline-block; 
	}
	
	#toolbar li h2{
		font-size: 12px;
	}
	
	.footer{
		text-align: center;
		margin-top: 3%;
		font-size: 12px;
		font-family: 'ms gothic';
		border-top: 1px solid #000;
	}
	
	.btn{
		border: 1px solid #000;
		border-radius: 2px;
		padding: 4px;
		box-shadow: .1em .1em #d3d3d3;
	}
</style>

<body>

<h2 id='title'> piano roll fun ʕ•ᴥ•ʔ</h2>

<div id='toolbar'>

	<ul>
		<li><h2 id='measures'></h2></li>
		<li>|</li>
		<li><h2 id='timeSig'></h2></li>
		<li>|</li>
		<li><h2 id='subdiv'></h2></li>
		<li>|</li>
		<li><h2 id='tempo'>120 bpm</h2></li>
	</ul>

	<ul>
		<li><button onclick='play()'> play! </button></li>
		<li><button onclick='playAll()'> play <b>all</b>! </button></li>
		<li><button onclick='stopPlay()'> stop! </button></li>
		<li><button onclick='addNewMeasure()'> add new measure </button></li>
		<li><button onclick='addNewInstrument()'> add new instrument </button></li>
		<li><button onclick='clearGrid()'> clear grid </button></li>
		<li>
			<label id='wavetypeLabel'> wave type:
			<select id='selectWave'>
				<option> sine </option>
				<option> square </option>
				<option> sawtooth </option>
				<option> triangle </option>
			</select>
			</label>
		</li>
		<li>
			<label id='tempoLabel'> tempo: 
			<input id='changeTempo' type='text'></input>
			</label>
		</li>
		<li>
			<button onclick='changeTempo()'> change tempo </button>
		</li>
	</ul>
	
</div>

<br>
<p> left-click to add and delete notes. right-click lets you subdivide a measure for 16th notes. rejoin to undo subdivision. </p>

<div>
	<table>
		<tr id='instrumentTable'>
			<td id='1' selected='1' style='background-color: rgb(188,223,70)' onclick='chooseInstrument(this.id)'> default instrument </td>
		</tr>
	</table>
</div>

<br>

<div id='piano'>
	<div id='columnHeaderRow'></div>
</div>


<div class='footer'>
	<p> c.2017 nch works </p>
</div>

</body>

<script>
//references:
//http://jsfiddle.net/remotesynth/73cD5/?utm_source=website&utm_medium=embed&utm_campaign=73cD5
//https://modernweb.com/creating-sound-with-the-web-audio-api-and-oscillators/
//http://www.phy.mtu.edu/~suits/notefreqs.html
//http://stackoverflow.com/questions/1114024/constructors-in-javascript-objects
//http://stackoverflow.com/questions/32239560/web-audio-oscillators-unexpectedly-glide-from-one-frequency-to-another-in-chrome
//http://stackoverflow.com/questions/15261030/web-audio-start-and-stop-oscillator-then-start-it-again
//http://stackoverflow.com/questions/18785951/how-to-get-width-of-a-div-in-percentage-using-jquery
//http://alemangui.github.io/blog//2015/12/26/ramp-to-value.html
//http://stackoverflow.com/questions/4909167/how-to-add-a-custom-right-click-menu-to-a-webpage
//https://swisnl.github.io/jQuery-contextMenu/docs.html
//http://stackoverflow.com/questions/11950811/get-id-of-clicked-element-which-opened-context-menu-using-jquery-contextmenu-plu
//http://stackoverflow.com/questions/22550424/how-can-i-change-the-background-color-of-multiple-divs-by-dragging-over-them-wit

// ooooh make it recordable!
// https://developer.mozilla.org/en-US/docs/Web/API/AudioContext/createMediaStreamDestination

//TODO:
/*
-allow color customizations for highlight, note blocks
-legato, staccato toggling for individual notes
-bend notes? :>
-need to customize instruments, i.e. name, type of wave, etc.
-be able to download/import json data of instruments/notes 
*/

/**** INFORMATION ABOUT THE CURRENT SETUP ****/
var numberOfMeasures = 4; 	// 4 measures by default
var subdivision = 8; 		// each measure subdivided by eighth notes
var timeSignature = "4/4";
var currentTempo = 500; 	// hold the current tempo - in milliseconds!! default is 120 bpm

$('#measures').html("number of measures: " + numberOfMeasures);
$('#timeSig').html("time signature: " + timeSignature);
$('#subdiv').html("subdivision: " + subdivision);

/**** SET UP AUDIO CONTEXT *****/
var context = new AudioContext();

// SET UP INITIAL INSTRUMENT
// this oscillator is used to hear notes when they get clicked on the grid
var g = initGain();
var oscillator = initOscillator(g);	
g.connect(context.destination);		// hook up gain with audio context

// put initial instrument in instruments object
var initialInstrument = new Instrument("Instrument 1", oscillator, g, []);
instruments.push(initialInstrument);
currentInstrument = instruments[0];

// create a new gain object
function initGain(){
	var newGain = context.createGain();
	// set gain to 0 initially so no sound will be heard 
	newGain.gain.value = 0.0;
	return newGain;
}

// create a new oscillator
function initOscillator(gain){
	var o = context.createOscillator();
	o.type = $('#selectWave').val();
	o.connect(gain); 
	o.start(0);
	return o;
}

/************** CHANGE TEMPO ******************/
//http://www.sengpielaudio.com/calculator-bpmtempotime.htm

function changeTempo(){
	var tempoInput = document.getElementById("changeTempo");
	var selectedTempo = parseInt(tempoInput.value);
	var tempoText = document.getElementById("tempo")
	tempoText.innerHTML = selectedTempo + " bpm";
	
	// initially getting milliseconds FOR QUARTER NOTES
	// note that currentTempo needs to be rounded before use
	currentTempo = ((Math.round((60000/selectedTempo) * 1000)) / 1000 );
	
	// go through all instruments and adjust duration of each note in their note arrays
	// according to new current tempo
	for(var i = 0; i < instruments.length; i++){
		if(instruments[i] != currentInstrument){
			var noteArray = instruments[i].notes;
			for(var j = 0; j < noteArray.length; j++){
				if(noteArray[j].duration > 1){
					noteArray[j].duration = getCorrectLength(noteArray[j].block.length, currentTempo);
				}
			}
		}
	}
}

function getCorrectLength(length, currentTempo){
	if(length === "quarter"){
		return Math.round(currentTempo);
	}else if(length === "eighth"){
		return Math.round(currentTempo / noteLengths["eighth"]);
	}else if(length === "sixteenth"){
		return Math.round(currentTempo / noteLengths["sixteenth"]);
	}
}

/************** DOM MODIFICATION *******************/

// allows for a note to sound temporarily when user clicks on a block 
function clickNote(id, waveType){

	var parent = document.getElementById(id).parentNode.id;
	parent = parent.replace('s', '#'); // replace any 's' with '#' so we can match a key in noteFrequencies
	
	setTimeout(function(){
		oscillator.type = waveType;
		oscillator.frequency.setValueAtTime(noteFrequencies[parent], 0);
		g.gain.value = .3;
		// this setTimeout makes sure the oscillator gets silent again
		setTimeout(function(){
			oscillator.frequency.value = 0.0;
			g.gain.value = 0;
		}, 100);
	}, 10); // use a small value like 10 so it starts "immediately"
}

// make blocks on grid clickable 
function addNote(id, type){
	if($('#' + id).css("background-color") === "rgb(0, 178, 0)"){
		$('#' + id).css("background-color", "transparent");
		
		// change hasNote attribute to false (0) in column header
		var headerId = id.substring(id.indexOf("col"));
		var currValue = parseInt(document.getElementById(headerId).getAttribute("hasNote"));
		document.getElementById(headerId).setAttribute("hasNote", --currValue);
		
		// if you choose a same note for the current instrument as another instrument, that will wipe out the 
		// 'onion-skin' of the other instrument's note. but if you delete that note for
		// the current instrument later, calling showOnionSkin() here will put back the 'onion-skin' for
		// the other instrument. there is no static 'onion-skin' layer. it's just changing the background-color 
		// of note blocks
		showOnionSkin(); 
		
	}else{
		$('#' + id).css("background-color", "rgb(0, 178, 0)");
		
		//change hasNote attribute to true (1) in column header
		var headerId = id.substring(id.indexOf("col"));
		var currValue = parseInt(document.getElementById(headerId).getAttribute("hasNote"));
		document.getElementById(headerId).setAttribute("hasNote", ++currValue);
	}
	var waveType = $('#' + type);
	clickNote(id, waveType.val());
}

// make a row highlightable on mouse over - easier to see what note a block is
function highlightRow(id, color){
	// get id of parent
	var parent = document.getElementById(id).parentNode.id;
	// highlight
	$('#' + parent).css('background-color', color);
}

// delete all notes
function clearGrid(){
	var columns = document.getElementById("columnHeaderRow").children;

	// start at 1 to ignore the column before 1 (the blank one)
	for(var i = 1; i < columns.length; i++){
		if(columns[i].getAttribute("hasnote") !== "0"){
			// change hasnote attribute back to 0!
			columns[i].setAttribute("hasnote", "0");
			var columnToCheck = $("div[id$='" + columns[i].id + "']").get();
			for(var j = 0; j < columnToCheck.length; j++){
				if(columnToCheck[j].style.backgroundColor === "rgb(0, 178, 0)"){
					columnToCheck[j].style.backgroundColor = "transparent";
				}
			}
		}
	}
}

// add a new measure 
function addNewMeasure(){

	$('#measures').text( "number of measures: " + (parseInt($('#measures').text().trim().split(' ').reverse()[0]) + 1) );
	
	// find the dummy node for the header columns and insert before that node
	// the new subdivisions of the new measure
	var dummy = $("div[id='columnHeaderRow_dummy']").get()[0];
	var dummyParent = dummy.parentNode;
	
	// new column headers 
	for(var i = 0; i < subdivision; i++){
		var newHeader = document.createElement('div');
		newHeader.id = "col_" + (numberOfMeasures * subdivision + i); 
		newHeader.style.width = '40px';
		newHeader.style.height = '12px';
		newHeader.style.fontSize = '10px';
		newHeader.style.display = 'inline-block';
		newHeader.style.textAlign = "center";
		
		// 0 == false; i.e. does not have a note in the column
		// this attribute should help optimize performance a bit
		newHeader.setAttribute("hasNote", 0); 
		
		newHeader.textContent =  i + 1;
		
		if(i + 1 === subdivision){
			newHeader.style.borderRight = "3px solid #000";
		}else{
			newHeader.style.borderRight = "1px solid #000";
		}
		dummyParent.insertBefore(newHeader, dummy);
	}
	
	// now add new columns for each note
	var noteRows = $('#piano').children().get();
	
	// start at 1 to skip column header row 
	for(var j = 1; j < noteRows.length; j++){
		for(var k = 0; k < subdivision; k++){
			// get the dummy element for this row
			dummy = $("div[id='" + noteRows[j].id + '_dummy' + "']").get()[0];
			var newColumn = document.createElement("div");
			newColumn.id = noteRows[j].id + "col_" + ((numberOfMeasures * subdivision) + k);
			// adjust id if needed
			newColumn.id = replaceSharp(newColumn.id);
			newColumn.style.display = 'inline-block';
			newColumn.style.width = '40px';
			newColumn.style.height = '15px';
			
			// IMPORTANT! new attributes for each note
			newColumn.setAttribute("volume", "");
			newColumn.setAttribute("length", "eighth"); // length of note (quarter, eighth?)
			newColumn.setAttribute("type", ""); // type of note - staccato, legato? 
			newColumn.className = "context-menu-one";
			
			if((k + 1) % subdivision == 0){
				newColumn.style.borderRight = "3px solid #000";
			}else{
				newColumn.style.borderRight = "1px solid #000";
			}

			// hook up an event listener to allow for selecting notes on the grid!
			//notice passing in id of option/select element for picking wave type. 
			newColumn.addEventListener("click", function(){ addNote(this.id, "selectWave") }); 
			// allow for highlighting to make it clear which note a block is
			newColumn.addEventListener("mouseenter", function(){ highlightRow(this.id, '#FFFF99') });
			newColumn.addEventListener("mouseleave", function(){ highlightRow(this.id, 'transparent') });
			noteRows[j].insertBefore(newColumn, dummy);
		}
		// adjust width of row 
		noteRows[j].style.width = parseInt(noteRows[j].style.width) + 20 + "%";
	}
	numberOfMeasures++; // increment measure variable
}

// choose an instrument 
function chooseInstrument(thisElement){
	// console.log(thisElement);
	// look at grid, collect the notes, save them to the current instrument, and
	// move on to the clicked-on instrument
	currentInstrument.notes = readInNotes();
	
	var instrumentsView = document.getElementById('instrumentTable').children;

	// change other instruments' label background color to transparent
	for(var i = 0; i < instrumentsView.length; i++){
		if(instrumentsView[i]){
			instrumentsView[i].style.backgroundColor = "transparent";
		}
	}
	
	// get index of clicked-on instrument in instrumentTable and subtract 1 to
	// account for 0-index when we use it to look in the global variable 'instruments' 
	// array for the corresponding instrument object
	var index = parseInt(thisElement) - 1;
	clearGrid();
	
	currentInstrument = instruments[index]; // this is the new instrument
	
	// then draw the previously-saved notes, if any, onto the grid of the clicked-on instrument
	drawNotes(currentInstrument); 
	
	showOnionSkin();
	
	$('#' + thisElement).css('background-color', 'rgb(188,223,70)');
	
}

// draw notes back on to grid
// takes an instrument object and uses its notes array data to draw back the notes
function drawNotes(instrumentObject){
	var notes = instrumentObject.notes;
	for(var i = 0; i < notes.length; i++){
		// only notes have a valid id (rests have null for id field)
		if(notes[i].block.id){
		
		    // if we switch between instruments that have different length notes in the same place
			// i.e. C3col_3 for instrument 1 has an eighth note, but then instrument 2 has 2 16th notes 
			// in the same place, which means that for instrument 2 there is not one C3col_3 column, but instead
			// C3col_3-1 and C3col_3-2 ! therefore, we need to take out or add new headers and columns as needed!
		
			var elementExists = document.getElementById( notes[i].block.id );
			
			// if we need to paint in an eighth note, but the column is currently subdivided 
			if(!elementExists && notes[i].block.length === "eighth"){
				// now have to look at whether the note to be placed on the grid is a 16th or 8th 
			    // easy case - the note to add is an 8th note. that means take away the 2 16th notes for this column and replace with 1 block
				// we can just remove the 2nd 16th block, rename the id of the 1st 16th block, change its attr 'length' to 'eighth', and change its length
				
				var blockId = notes[i].block.id;
				
				rejoin(blockId, true);
		
				// now that the correct column should be in place, assign elementExists the id of the note we need to draw in 
				elementExists = document.getElementById( notes[i].block.id );
			
			}else if(!elementExists && notes[i].block.length === "sixteenth"){
				// now if the note to draw in is a 16th note and there's no place to put it, create the subdivision
				// because the note being looked at currently will have a "-1" or "-2" appended, we need to remove that
				// to find the correct column to subdivide, since the only columns available right now are eighth note columns
				// without -1 and -2
				var blockId = notes[i].block.id;
				var columnToFind = blockId.substring(0, blockId.indexOf("-"));
				subdivide(columnToFind, true);
				
				elementExists = document.getElementById( notes[i].block.id );
			}
			
			// make sure to set column header attr "hasNote" to 1!!!
			var columnHeader = elementExists.id.substring(elementExists.id.indexOf("col_"));
			columnHeader = document.getElementById(columnHeader);
			columnHeader.setAttribute("hasnote", "1");
			
			// color in note
			elementExists.style.backgroundColor = "rgb(0, 178, 0)";
		}
	}
}

/***** PRODUCE THE GRID HEADER ********/
// dynamically produce piano roll 
var thePiano = $('#piano');
var columnHeaderRow = $('#columnHeaderRow');

// this will provide the headers for each column in the grid (i.e. number for each beat/subbeat) 
for(var i = 0; i < numberOfMeasures * subdivision + 1; i++){
	var columnHeader = document.createElement('div');
	columnHeader.id = "col_" + (i - 1); // the - 1 here is important! 
	columnHeader.style.display = "inline-block";
	
	if(i > 0){
		columnHeader.style.borderRight = "1px solid #000";
		columnHeader.style.textAlign = "center";
		
		if(i < subdivision + 1){
			if(i === subdivision){
				columnHeader.style.borderRight = '3px solid #000';
			}
			columnHeader.textContent = i;
		}else if(i !== numberOfMeasures * subdivision + 1){
			// subdiv goes from 1 to 16. if more than 16, start at 1 again. 
			var subdiv = (i % subdivision) === 0 ? subdivision : (i % subdivision);
			if(subdivision === subdiv){
				columnHeader.style.borderRight = '3px solid #000';
			}
			columnHeader.textContent = subdiv; 
		}
	}
	
	if(i === 0){
		columnHeader.style.width = '50px';
		columnHeader.style.height = '12px';
		columnHeader.style.border = '1px solid #000';
	}else{
		columnHeader.style.width = '40px';
		columnHeader.style.height = '12px';
		columnHeader.style.fontSize = '10px';
	}
	
	// 0 == false; i.e. does not have a note in the column
	columnHeader.setAttribute("hasNote", 0); 
	
	columnHeaderRow.append(columnHeader);
}
// can't pass in a jquery selected element
appendDummyElement(document.getElementById('columnHeaderRow'));

/******* BUILDING THE GRID ********/
var note;
for(note in noteFrequencies){
	
	note = note;
	
    // ignore enharmonics 
    if(note.substring(0, 2) === "Gb" || note.substring(0, 2) === "Db" ||
	   note.substring(0, 2) === "D#" || note.substring(0, 2) === "G#" ||
	   note.substring(0, 2) === "A#"){
		continue;
	}
	
	//first create new element for new pitch
	var newRow = document.createElement('div');
	newRow.id = replaceSharp(note);
	
	var newRowText = document.createElement('div');
	newRowText.innerHTML = note.substring(0, note.length - 1) + "<sub>" + note[note.length-1] + "</sub>";
	newRowText.style.fontSize = '11px';
	newRowText.style.border = "1px solid #000";
	newRowText.style.display = 'inline-block';
	newRowText.style.width = "50px";
	newRowText.style.verticalAlign = "middle";
	
	newRow.appendChild(newRowText);
	thePiano.append(newRow);
	/* append columns to each row */
	for(var j = 0; j < numberOfMeasures * subdivision; j++){
		var column = document.createElement("div");
		column.id = replaceSharp(note) + "col_" + j;
		column.style.display = 'inline-block';
		//column.style.cssFloat = "left";
		column.style.width = "40px";
		column.style.height = "15px";
		column.style.verticalAlign = "middle";
	
		// IMPORTANT! new attributes for each note
		column.setAttribute("volume", "");
		column.setAttribute("length", "eighth"); // length of note (quarter, eighth?)
		column.setAttribute("type", ""); // type of note - staccato, legato? 
		column.className = "context-menu-one";
		
		if((j + 1) % subdivision == 0){
			column.style.borderRight = "3px solid #000";
		}else{
			column.style.borderRight = "1px solid #000";
		}

		// hook up an event listener to allow for picking notes on the grid!
		column.addEventListener("click", function(){ addNote(this.id, "selectWave") });
		// allow for highlighting to make it clear which note a block is
		column.addEventListener("mouseenter", function(){ highlightRow(this.id, '#FFFF99') });
		column.addEventListener("mouseleave", function(){ highlightRow(this.id, 'transparent') });
		newRow.appendChild(column);
	}
	//
	//this was used previously to clear the float lefts when I floated all the grid blocks left.
	//but since they're all now display: inline-block instead, which works much better, this is
	//really an artifact now. 
	appendDummyElement(newRow);
}

// helper function to replace '#' in string 
function replaceSharp(string){
	// this adjustment is only necessary for labeling the DOM elements so that they're clickable
	// previously, without this adjustment, sometimes you'd get a string id with two '#' chars for the sharp notes,
	// because of how I decided to label my ids. since you also need a # for jQuery selection, adjustment is necessary. 
	if(string.indexOf('#') != -1){
		return string.replace('#', 's'); // s for sharp
	}
	// otherwise do nothing
	return string;
}

// onion-skin!!
// see where the other instruments' notes are 
function showOnionSkin(){
	for(var i = 0; i < instruments.length; i++){
		if(instruments[i] !== currentInstrument){
			// go through each instrument's notes
			for(var j = 0; j < instruments[i].notes.length; j++){
	
				if(instruments[i].notes[j].block.id === null){
					continue;
				}
				
				// get note id 
				var noteId = instruments[i].notes[j].block.id;
				// get location of each note
				var location = document.getElementById(noteId);
		
				if(!location){
					// if not present, it's either because there's no 16th measure or 8th measure
					if(noteId.indexOf("-1") < 0 && noteId.indexOf("-2") < 0){
						
						// ok so this note that we want to 'onion-skin' looks like an eighth note but
						// there's only the 16th note subdivisions available on the grid. 
						// so we'll find those subdivisions and just color them
						var subdiv = document.getElementById( noteId + "-1" );
						
						// color the subdiv AND its right sibling 
						if(subdiv.style.backgroundColor !== "rgb(0, 178, 0)"){
							subdiv.style.backgroundColor = "rgba(0, 178, 0, 0.2)";
							if(subdiv.nextSibling.style.backgroundColor !== "rgb(0, 178, 0)"){
								subdiv.nextSibling.style.backgroundColor = "rgba(0, 178, 0, 0.2)";
							}
						}
						
						/****
						warning! you also have to consider later quarter notes and longer notes.
						the function will have to be able to look at the attribut "length" to know 
						how many sibling elements to color!
						***/
					}else if(noteId.indexOf("-1") > 0){
						var findId = noteId.substring(0, noteId.indexOf("-"));
						var subdiv = document.getElementById(findId);
						if(subdiv.style.backgroundColor !== "rgb(0, 178, 0)"){
							subdiv.style.backgroundColor = "rgba(0, 178, 0, 0.2)";
						}
					}else if(noteId.indexOf("-2") > 0){
						// make a temporary div that will be inserted into the corresponding eighth note column
						// make a special class for this div. remove it when switching instruments 
						// but then would I have to take care of it on playback? no because it doesn't even have "hasnote" attribute!

					}
				}
				
				if(location && instruments[i].notes[j].freq > 1){
					// set background color for that location a very light shade of green
					if(location.style.backgroundColor === "transparent"){
						location.style.backgroundColor = "rgba(0, 178, 0, 0.2)";
					}
				}
			}
		}
	}
}

function appendDummyElement(elementToAppendTo){
	var dummyElement = document.createElement('div');
	dummyElement.id = elementToAppendTo.id + "_dummy";
	elementToAppendTo.appendChild(dummyElement);
}

/******* GET NOTES AND PLAY ******/

/* this will read all the notes, put them in an array and returns the array */
function readInNotes(){
	var notes = []; // don't worry about what was in notes previously. 
	
	// first find what the last column with a note (hasnote === 1) is 
	// this will aid performance and prevent unnecessary column look-throughs 
	var columnHeaders = document.getElementById("columnHeaderRow").children;
	var lastColumn = -1;
	for(var k = 0; k < columnHeaders.length; k++){
		if(columnHeaders[k].getAttribute('hasnote') === '1'){
			lastColumn = k;
		}
	}
	// gather each column
	// start at 1 to skip 0th index, which is not a valid note column
	for(var i = 1; i <= lastColumn; i++){

		var column = $("div[id$='" + columnHeaders[i].id + "']").get(); //get all the blocks in each column
		var found = 0;
		
		// go down each column and look for green. if found, stop and add to array. then move on.
		for(var j = 0; j < column.length; j++){
			// look for green background! 
			if(column[j].style.backgroundColor === "rgb(0, 178, 0)"){
				found = 1;
				// make any corrections to id string before matching with freq key
				var freq = noteFrequencies[ (column[j].parentNode.id).replace('s', '#') ];
				// add note to array
				notes.push(new Note(freq, getCorrectLength(column[j].getAttribute("length"), currentTempo), column[j]));
				// note found, stop 
				break;
			}
		}
		
		// if found === 0, then add a rest. need to know what kind of note this current column represents first.
		if(found === 0){
			if(columnHeaders[i].id.indexOf("-1") > 0 || columnHeaders[i].id.indexOf("-2") > 0){
				notes.push(new Note(0.0,  Math.round(currentTempo / noteLengths["sixteenth"]), column[i]));
			}else{
				notes.push(new Note(0.0,  Math.round(currentTempo / noteLengths["eighth"]), column[i]));
			}
		}
	}
	
	return notes;
}


/* 
this function takes an array of notes, an index, and an oscillator and plays the note at that index 
with a specific duration with the passed-in oscillator.
*/
function readAndPlayNote(array, index, oscillatorNode, gainNode){  
	// when to stop playing 
	if(index === array.length){
		gainNode.gain.value = 0;
	}else{
		oscillatorNode.type = $('#selectWave').val();
		/* tip! by setting value at a certain time, this prevents the 'gliding' from one freq. to the next */
		oscillatorNode.frequency.setValueAtTime(array[index].freq, 0);
		// by setting gain value here according to the two conditions, this allows for the 'articulation' of notes without 
		// the 'helicopter' sound when a certain note frequency is 0. 
		// previously, the gain would have been .3 even for notes with 0 frequency,
		// which causes some increase in volume in background sound.
		// it was only detectable when I added the setTimeout below where I set gain to 0.
		// this is fixed by always setting gain to 0 if a note's frequency is 0.
		gainNode.gain.value = array[index].freq > 0 ? .3 : 0.0;
		if(index < array.length){
			// hold the current note for whatever duration was specified
			// in other words, hold this current note for array[index].duration, then move on to the next note.
			// note that index is pre-incremented for the next note, but we also need the duration for this current index!
			// therefore, currIndex will hold the current note's index.
			var currIndex = index;
			
			// change gain to 0 after a really small amount of time to give the impression of articulation
			// 100 might have to be a better value later to coordinate with when the next note will play
			setTimeout(function(){ gainNode.gain.value = 0.0; }, 100); 
			
			// create a new timer and push to timers array 
			timer = setTimeout(function(){readAndPlayNote(array, ++index, oscillatorNode, gainNode)}, array[currIndex].duration); 
		}
	}
}

// stop playback 
function stopPlay(){
	clearTimeout(timer);
	for(var i = 0; i < instruments.length; i++){
		instruments[i].gain.gain.value = 0.0;
	}
}

// play notes for current instrument
function play(){
	readAndPlayNote(readInNotes(), 0, currentInstrument.oscillator, currentInstrument.gain);
}

// play all instruments 
function playAll(){
	currentInstrument.notes = readInNotes();
	for(var i = 0; i < instruments.length; i++){
		readAndPlayNote(instruments[i].notes, 0, instruments[i].oscillator, instruments[i].gain);
	}
}

/**********  ADD A NEW INSTRUMENT FUNCTIONS ************/
function addNewInstrument(){
	var instrumentTable = document.getElementById("instrumentTable");
	var newInstrument = document.createElement('td');
	
	// we want to be able to access the instruments in sequential order
	newInstrument.id = "" + (instruments.length + 1); 
	newInstrument.setAttribute("selected", "0");
	newInstrument.style.backgroundColor = "transparent";
	
	newInstrument.innerHTML = "new_instrument";
	newInstrument.addEventListener('click', function(event){
		// pass the event target's id to chooseInstrument()
		chooseInstrument(event.target.id);
	});
	
	instrumentTable.appendChild(newInstrument);
	
	createNewInstrument("blah");
}

function createNewInstrument(name){
	// make new oscillator and gain nodes
	var newGain = initGain();
	var newOscillator = initOscillator(newGain);
	newGain.connect(context.destination);
	
	// create new instrument with oscillator
	var newInstrument = new Instrument("blah", newOscillator, newGain, []);
	instruments.push(newInstrument);
}

function deleteInstrument(){
}



/****  CONTEXT MENU  *****/
$(function(){
    $.contextMenu({
        selector: '.context-menu-one', 
        callback: function(key, options) {
            var m = "global: " + key;
            window.console && console.log(m) || alert(m); 
        },
        items: {
            "edit": {
                name: "Edit", 
                icon: "edit", 
                // supersedes "global" callback
                callback: function(key, options) {
                    var m = "edit was clicked";
                    window.console && console.log(m) || alert(m); 
                }
            },
            "Subdivide": {
				name: "Subdivide", 
				icon: "cut",
				callback: function(key, options){
					// get the id of the clicked-on block
					var id = options.$trigger.attr("id");
					subdivide(id, false);		
				}
			},
			"Rejoin": {
				name: "Rejoin",
				icon: "paste",
				callback: function(key, options){
					// if user wants to join two notes, they must be adjacent and the same note!
					// so check if adjacent 
					rejoin(options.$trigger.attr("id"), false); // preserve any green notes 
				}
			},
            "Delete": {
				name: "Delete", 
				icon: "delete",
				callback: function(key, options){
					//console.log(options);
					//alert(options.$trigger.attr("id") );
					var block = document.getElementById(options.$trigger.attr("id"));
					block.style.backgroundColor = "transparent";
				}
			}
        }
    });
});


// pass in id of an element, as well as true or false - true to clear the column of green, false to preserve notes
function subdivide(elementId, clearColumn){

	// get the id of the clicked-on block
	var id = elementId; //options.$trigger.attr("id");

	// check if already subdivided once! prevent 32nd notes for now 
	if(id.indexOf('-2') > 0){
		return;
	}

	var colNum = id.substring(id.indexOf("col"));
	var column =  $("div[id$='" + colNum + "']").get();

	/* revise column header first */
	var colHead = column[0];
	colHead.id = colHead.id + "-1";
	//console.log(column);
	// split the header as well, but keep the 2nd half invisible
	// by making width 0
	var columnHalf = colHead.cloneNode(false);
	columnHalf.style.width = 0;
	columnHalf.style.borderRight = "";
	columnHalf.id = colNum + "-2";
	colHead.parentNode.insertBefore(columnHalf, colHead.nextSibling);
	//console.log(column);

	for(var i = 1; i < column.length; i++){

		// then split the block into 2 
		var block = column[i];//document.getElementById(id);
		
		// this is the new, 2nd block
		var block2 = block.cloneNode(false);
		
		// if clearColumn is true, make sure all blocks are transparent
		if(clearColumn){
			block.style.backgroundColor = "transparent";
			block2.style.backgroundColor = "transparent";
		}
		
		// now make some changes to the style for block and block2 
		block.style.width = '19px';
		block.setAttribute("length", "sixteenth");
		block.style.borderRight = "1px solid #000";
		block.id = block.id + "-1";
		
		//block.addEventListener("click", function(){ addNote(block.id, "selectWave") }); 
		block.addEventListener("mouseenter", function(){ highlightRow(block.id, '#FFFF99') });
		block.addEventListener("mouseleave", function(){ highlightRow(block.id, 'transparent') });
		block.className = "context-menu-one";
		
		block2.setAttribute("length", "sixteenth");
		block2.style.width = '20px';
		block2.id = block2.id + "-2"; // give new id to block2
		block2.className = "context-menu-one";
		
		block2.addEventListener("click", function(){ addNote(this.id, "selectWave") }); 
		block2.addEventListener("mouseenter", function(){ highlightRow(block2.id, '#FFFF99') });
		block2.addEventListener("mouseleave", function(){ highlightRow(block2.id, 'transparent') });
		
		// then put block2 after block1 in DOM
		block.parentNode.insertBefore(block2, block.nextSibling);		
	}
}

// take an element node id as parameter, and true or false if you want to clear a whole column (no green in any block of the column)
function rejoin(elementId, clearColumn){

	var block = elementId;
	if(elementId.indexOf("-1") < 0){
		// the elementId passed should always have a -1 appended for the left 16th note column. 
		block = block + "-1";
	}
	block = document.getElementById(block);
	var adjacentBlock = block.nextSibling; 
	var blockHeader = block.id.substring(block.id.indexOf("col_"));
	var column =  $("div[id$='" + blockHeader + "']").get(); //only get the left-side 16th notes of subdivision
	blockHeader = column[0];
	
	// join two 16th note columns - must join from left!!!
	if(blockHeader.id.indexOf("-2") < 0){
		
		// take care of column header first 
		// blockHeader.setAttribute("length", "eighth");
		blockHeader.id = blockHeader.id.substring(0, blockHeader.id.indexOf("-"));
		
		// delete adjacent 16th block
		blockHeader.parentNode.removeChild(blockHeader.nextSibling);
		
		// then take care rest of column
		for(var i = 1; i < column.length; i++){
			blockHeader = column[i];
			blockHeader.style.width = "40px";
			blockHeader.setAttribute("length", "eighth");
			
			if(clearColumn){
				blockHeader.style.backgroundColor = "transparent";
			}
			
			blockHeader.id = blockHeader.id.substring(0, blockHeader.id.indexOf("-"));
			blockHeader.parentNode.removeChild(blockHeader.nextSibling);
		}
	}
	
	
	if(block.style.backgroundColor === "rgb(0, 178, 0)" && 
	   adjacentBlock.style.backgroundColor === "rgb(0, 178, 0)"){
	
	
		//console.log("ok to rejoin");
		// take the length of the adjacent block and add it to the current block
		// i.e. if current block is an eighth, and the adjacent is sixteenth, 
		// change the current block length attribute to "eighth-sixteenth"
		// (make sure to add 'eighth-sixteenth' as a length option in the length object in globals)
		
		// then remove the right border from the current block so the note looks elongated appropriately
		
		// important! change the current block's COLUMN HEADER's attribute "hasNote" to "1.5" !!!
		// then in the readInNotes function, when you loop through the headers, if it sees 1.5, this means
		// the current column has an eighth note joined with a sixteenth! so make sure to skip the next column.
		// this way, no additional unnecessary notes will get added to the notes array.  
		// additionally, add support for "hasNote === 2, 2.5, 3, 3.5, 4, ..."
		
		// ok, but how about deleting different length notes? 
		// how about this - keep a "head" reference attribute to an adjoined note. i.e. 
		// if eighth note with adjacent sixteenth, click join on eighth, the sixteenth note will have an attribute "head"
		// which is the id of the sixteenth. 
		// so if you had 4 eighth notes and joined them, but want to delete, you can click on any of the 4 and by using "head"
		// you will know which block to start and end to delete. make sure to give all of their borders back.
		// also, make sure to adjust headers' "hasNote" attribute back to 0.
		// and get rid of the 16th note nodes! i.e. delete "-1" and "-2"
		
		// subdivide on different length notes?
		// prevent subdividing on different length notes. allow subdividing on eighth notes only for now. 
		// i.e. make sure header has "hasNote === 0" before subdividing.
		
		// also, need to think about this 
		// when switching instruments, you need to also go through each note block's length attribute 
		// in the notes array to determine if any changes need to be made to any note block borders and
		// background color. have to consider eighth-sixteenth notes and different lengths 
		// need to make sure whatever lengths are given to each note in the notes array is REFLECTED WHEN
		// SWITCHING INSTRUMENTS! this means when switching, loop through notes array, look at length of each note,
		// and then doing the subdivide or rejoin as needed. therefore, subdivide and rejoin should be separate, standalone functions!
		
	}


}


</script>


</html>
