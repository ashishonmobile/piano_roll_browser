<!doctype html>

<head>
	<title> piano roll in the browser wow </title>
	<script src='https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js'></script>
	<script src='scripts/classes.js'></script>
	<script src='scripts/globals.js'></script>
	<script src='scripts/dom_modification.js'></script>
	<script src='scripts/grid_builder.js'></script>
	<script src='scripts/functionality.js'></script>
	
	
	<!-- stuff needed for contextMenu -->
	<link rel="stylesheet" href="https://swisnl.github.io/jQuery-contextMenu/css/screen.css" type="text/css"/>
    <!-- <link rel="stylesheet" href="https://swisnl.github.io/jQuery-contextMenu/css/theme.css" type="text/css"/> -->
    <!-- <link rel="stylesheet" href="https://swisnl.github.io/jQuery-contextMenu/css/theme-fixes.css" type="text/css"/> -->
    <!-- <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.4/styles/github.min.css"> -->
    <link href="https://swisnl.github.io/jQuery-contextMenu/dist/jquery.contextMenu.css" rel="stylesheet" type="text/css" />
    <script src="https://swisnl.github.io/jQuery-contextMenu/dist/jquery.contextMenu.js" type="text/javascript"></script>
    <script src="https://swisnl.github.io/jQuery-contextMenu/dist/jquery.ui.position.min.js" type="text/javascript"></script>
    <script src="https://swisnl.github.io/jQuery-contextMenu/js/main.js" type="text/javascript"></script>

	<meta charset='utf-8'>
</head>

<style>
	html{
		font-family: Arial;
	}
	
	/* override padding-bottom from contextMenu/css/screen.css */
	html body{
		padding-bottom: 0;
	}
	
	table, tr, td{
		border: 1px solid #000;
	}

	#piano{
		display: inline-block;
		
		/* this is important for letting the grid expand horizontally */
		white-space: nowrap;
	}
	
	#wavetypeLabel, #tempoLabel{
		font-family: 'arial', 'gothic ms';
		font-size: 14px;
		padding-left: 10px;
	}
	
	#changeTempo{
		width: 40px;
	}
	
	#title{
		margin: 0;
	}
	
	ul{
		padding: 0;
		margin: 0;
	}
	
	#toolbar li{
		list-style-type: none;
		display: inline-block; 
	}
	
	#toolbar li h2{
		font-size: 12px;
	}
	
	.footer{
		text-align: center;
		margin-top: 3%;
		font-size: 12px;
		font-family: 'ms gothic';
		border-top: 1px solid #000;
	}
	
	.btn{
		border: 1px solid #000;
		border-radius: 2px;
		padding: 4px;
		box-shadow: .1em .1em #d3d3d3;
	}
</style>

<body>

<h2 id='title'> piano roll fun ʕ•ᴥ•ʔ</h2>

<div id='toolbar'>

	<ul>
		<li><h2 id='measures'></h2></li>
		<li>|</li>
		<li><h2 id='timeSig'></h2></li>
		<li>|</li>
		<li><h2 id='subdiv'></h2></li>
		<li>|</li>
		<li><h2 id='tempo'>120 bpm</h2></li>
	</ul>

	<ul>
		<li><button onclick='play()'> play! </button></li>
		<li><button onclick='playAll()'> play <b>all</b>! </button></li>
		<li><button onclick='stopPlay()'> stop! </button></li>
		<li><button onclick='addNewMeasure()'> add new measure </button></li>
		<li><button onclick='addNewInstrument()'> add new instrument </button></li>
		<li><button onclick='clearGrid()'> clear grid </button></li>
		<li>
			<label id='wavetypeLabel'> wave type:
			<select id='selectWave'>
				<option> sine </option>
				<option> square </option>
				<option> sawtooth </option>
				<option> triangle </option>
			</select>
			</label>
		</li>
		<li>
			<label id='tempoLabel'> tempo: 
			<input id='changeTempo' type='text'></input>
			</label>
		</li>
		<li>
			<button onclick='changeTempo()'> change tempo </button>
		</li>
	</ul>
	
</div>

<br>
<p> left-click to add and delete notes. right-click lets you subdivide a measure for 16th notes. rejoin to undo subdivision. </p>

<div>
	<table>
		<tr id='instrumentTable'>
			<td id='1' selected='1' style='background-color: rgb(188,223,70)' onclick='chooseInstrument(this.id)'> default instrument </td>
		</tr>
	</table>
</div>

<br>

<div id='piano'>
	<div id='columnHeaderRow'></div>
</div>


<div class='footer'>
	<p> c.2017 nch works </p>
</div>

</body>

<script>
//references:
//http://jsfiddle.net/remotesynth/73cD5/?utm_source=website&utm_medium=embed&utm_campaign=73cD5
//https://modernweb.com/creating-sound-with-the-web-audio-api-and-oscillators/
//http://www.phy.mtu.edu/~suits/notefreqs.html
//http://stackoverflow.com/questions/1114024/constructors-in-javascript-objects
//http://stackoverflow.com/questions/32239560/web-audio-oscillators-unexpectedly-glide-from-one-frequency-to-another-in-chrome
//http://stackoverflow.com/questions/15261030/web-audio-start-and-stop-oscillator-then-start-it-again
//http://stackoverflow.com/questions/18785951/how-to-get-width-of-a-div-in-percentage-using-jquery
//http://alemangui.github.io/blog//2015/12/26/ramp-to-value.html
//http://stackoverflow.com/questions/4909167/how-to-add-a-custom-right-click-menu-to-a-webpage
//https://swisnl.github.io/jQuery-contextMenu/docs.html
//http://stackoverflow.com/questions/11950811/get-id-of-clicked-element-which-opened-context-menu-using-jquery-contextmenu-plu
//http://stackoverflow.com/questions/22550424/how-can-i-change-the-background-color-of-multiple-divs-by-dragging-over-them-wit
//http://www.sengpielaudio.com/calculator-bpmtempotime.htm

// ooooh make it recordable!
// https://developer.mozilla.org/en-US/docs/Web/API/AudioContext/createMediaStreamDestination

//TODO:
/*
-allow color customizations for highlight, note blocks
-legato, staccato toggling for individual notes
-bend notes? :>
-need to customize instruments, i.e. name, type of wave, etc.
-be able to download/import json data of instruments/notes 
*/

/**** INFORMATION ABOUT THE CURRENT SETUP ****/
var numberOfMeasures = 4; 	// 4 measures by default
var subdivision = 8; 		// each measure subdivided by eighth notes
var timeSignature = "4/4";
var currentTempo = 500; 	// hold the current tempo - in milliseconds!! default is 120 bpm

$('#measures').html("number of measures: " + numberOfMeasures);
$('#timeSig').html("time signature: " + timeSignature);
$('#subdiv').html("subdivision: " + subdivision);

/**** SET UP AUDIO CONTEXT *****/
var context = new AudioContext();

// SET UP INITIAL INSTRUMENT
// this oscillator is used to hear notes when they get clicked on the grid
var g = initGain();
var oscillator = initOscillator(g);	
g.connect(context.destination);		// hook up gain with audio context

// put initial instrument in instruments object
var initialInstrument = new Instrument("Instrument 1", oscillator, g, []);
instruments.push(initialInstrument);
currentInstrument = instruments[0];

// create a new gain object
function initGain(){
	var newGain = context.createGain();
	// set gain to 0 initially so no sound will be heard 
	newGain.gain.value = 0.0;
	return newGain;
}

// create a new oscillator
function initOscillator(gain){
	var o = context.createOscillator();
	o.type = $('#selectWave').val();
	o.connect(gain); 
	o.start(0);
	return o;
}


/***** PRODUCE THE GRID HEADER ********/
// dynamically produce piano roll 

buildGridHeader('columnHeaderRow');
buildGrid('piano');


/****  CONTEXT MENU  *****/
$(function(){
    $.contextMenu({
        selector: '.context-menu-one', 
        callback: function(key, options) {
            var m = "global: " + key;
            window.console && console.log(m) || alert(m); 
        },
        items: {
            "edit": {
                name: "Edit", 
                icon: "edit", 
                // supersedes "global" callback
                callback: function(key, options) {
                    var m = "edit was clicked";
                    window.console && console.log(m) || alert(m); 
                }
            },
            "Subdivide": {
				name: "Subdivide", 
				icon: "cut",
				callback: function(key, options){
					// get the id of the clicked-on block
					var id = options.$trigger.attr("id");
					subdivide(id, false);		
				}
			},
			"Rejoin": {
				name: "Rejoin",
				icon: "paste",
				callback: function(key, options){
					// if user wants to join two notes, they must be adjacent and the same note!
					// so check if adjacent 
					rejoin(options.$trigger.attr("id"), false); // preserve any green notes 
				}
			},
            "Delete": {
				name: "Delete", 
				icon: "delete",
				callback: function(key, options){
					//console.log(options);
					//alert(options.$trigger.attr("id") );
					var block = document.getElementById(options.$trigger.attr("id"));
					block.style.backgroundColor = "transparent";
				}
			}
        }
    });
});


// pass in id of an element, as well as true or false - true to clear the column of green, false to preserve notes
function subdivide(elementId, clearColumn){

	// get the id of the clicked-on block
	var id = elementId; //options.$trigger.attr("id");

	// check if already subdivided once! prevent 32nd notes for now 
	if(id.indexOf('-2') > 0){
		return;
	}

	var colNum = id.substring(id.indexOf("col"));
	var column =  $("div[id$='" + colNum + "']").get();

	/* revise column header first */
	var colHead = column[0];
	colHead.id = colHead.id + "-1";

	// split the header as well, but keep the 2nd half invisible
	// by making width 0
	var columnHalf = colHead.cloneNode(false);
	columnHalf.style.width = 0;
	columnHalf.style.borderRight = "";
	columnHalf.id = colNum + "-2";
	colHead.parentNode.insertBefore(columnHalf, colHead.nextSibling);

	for(var i = 1; i < column.length; i++){

		// then split the block into 2 
		var block = column[i];
		
		// this is the new, 2nd block
		var block2 = block.cloneNode(false);
		
		// check if onion skin on any column blocks
		if(block.style.background === "linear-gradient(90deg, rgba(0, 178, 0, 0.2) 50%, transparent 50%)"){
			// make sure original block keeps background, but not block 2
			block.style.background = "";
			block2.style.background = "";
			block.style.backgroundColor = "rgba(0, 178, 0, .2)";
		}else if(block.style.background === "linear-gradient(90deg, transparent 50%, rgba(0, 178, 0, 0.2) 50%)"){
			block.style.background = "";
			block2.style.background = "";
			block2.style.backgroundColor = "rgba(0, 178, 0, .2)";
		}
		
		// if clearColumn is true, make sure all blocks are transparent
		if(clearColumn){
			block.style.backgroundColor = "transparent";
			block.style.background = ""; /* this is in case linear-gradient is applied */
			block2.style.backgroundColor = "transparent";
			block2.style.background = "";
		}
		
		// now make some changes to the style for block and block2 
		block.style.width = '19px';
		block.setAttribute("length", "sixteenth");
		block.style.borderRight = "1px solid #000";
		block.id = block.id + "-1";
		
		//block.addEventListener("click", function(){ addNote(block.id, "selectWave") }); 
		block.addEventListener("mouseenter", function(){ highlightRow(block.id, '#FFFF99') });
		block.addEventListener("mouseleave", function(){ highlightRow(block.id, 'transparent') });
		block.className = "context-menu-one";
		
		block2.setAttribute("length", "sixteenth");
		block2.style.width = '20px';
		block2.id = block2.id + "-2"; // give new id to block2
		block2.className = "context-menu-one";
		
		block2.addEventListener("click", function(){ addNote(this.id, "selectWave") }); 
		block2.addEventListener("mouseenter", function(){ highlightRow(block2.id, '#FFFF99') });
		block2.addEventListener("mouseleave", function(){ highlightRow(block2.id, 'transparent') });
		
		// then put block2 after block1 in DOM
		block.parentNode.insertBefore(block2, block.nextSibling);		
	}
	
}

// take an element node id as parameter, and true or false if you want to clear a whole column (no green in any block of the column)
function rejoin(elementId, clearColumn){

	var block = elementId;
	if(elementId.indexOf("-1") < 0){
		// the elementId passed should always have a -1 appended for the left 16th note column. 
		block = block + "-1";
	}
	block = document.getElementById(block);
	var adjacentBlock = block.nextSibling; 
	var blockHeader = block.id.substring(block.id.indexOf("col_"));
	var column =  $("div[id$='" + blockHeader + "']").get(); //only get the left-side 16th notes of subdivision
	blockHeader = column[0];
	
	// join two 16th note columns - must join from left!!!
	if(blockHeader.id.indexOf("-2") < 0){
		
		// take care of column header first 
		// blockHeader.setAttribute("length", "eighth");
		blockHeader.id = blockHeader.id.substring(0, blockHeader.id.indexOf("-"));
		
		// delete adjacent 16th block
		blockHeader.parentNode.removeChild(blockHeader.nextSibling);
		
		// then take care rest of column
		for(var i = 1; i < column.length; i++){
			blockHeader = column[i];
			blockHeader.style.width = "40px";
			blockHeader.setAttribute("length", "eighth");
			
			if(clearColumn){
				blockHeader.style.backgroundColor = "transparent";
			}
			
			blockHeader.id = blockHeader.id.substring(0, blockHeader.id.indexOf("-"));
			blockHeader.parentNode.removeChild(blockHeader.nextSibling);
		}
	}
	
	
	if(block.style.backgroundColor === "rgb(0, 178, 0)" && 
	   adjacentBlock.style.backgroundColor === "rgb(0, 178, 0)"){
	
	
		//console.log("ok to rejoin");
		// take the length of the adjacent block and add it to the current block
		// i.e. if current block is an eighth, and the adjacent is sixteenth, 
		// change the current block length attribute to "eighth-sixteenth"
		// (make sure to add 'eighth-sixteenth' as a length option in the length object in globals)
		
		// then remove the right border from the current block so the note looks elongated appropriately
		
		// important! change the current block's COLUMN HEADER's attribute "hasNote" to "1.5" !!!
		// then in the readInNotes function, when you loop through the headers, if it sees 1.5, this means
		// the current column has an eighth note joined with a sixteenth! so make sure to skip the next column.
		// this way, no additional unnecessary notes will get added to the notes array.  
		// additionally, add support for "hasNote === 2, 2.5, 3, 3.5, 4, ..."
		
		// ok, but how about deleting different length notes? 
		// how about this - keep a "head" reference attribute to an adjoined note. i.e. 
		// if eighth note with adjacent sixteenth, click join on eighth, the sixteenth note will have an attribute "head"
		// which is the id of the sixteenth. 
		// so if you had 4 eighth notes and joined them, but want to delete, you can click on any of the 4 and by using "head"
		// you will know which block to start and end to delete. make sure to give all of their borders back.
		// also, make sure to adjust headers' "hasNote" attribute back to 0.
		// and get rid of the 16th note nodes! i.e. delete "-1" and "-2"
		
		// subdivide on different length notes?
		// prevent subdividing on different length notes. allow subdividing on eighth notes only for now. 
		// i.e. make sure header has "hasNote === 0" before subdividing.
		
		// also, need to think about this 
		// when switching instruments, you need to also go through each note block's length attribute 
		// in the notes array to determine if any changes need to be made to any note block borders and
		// background color. have to consider eighth-sixteenth notes and different lengths 
		// need to make sure whatever lengths are given to each note in the notes array is REFLECTED WHEN
		// SWITCHING INSTRUMENTS! this means when switching, loop through notes array, look at length of each note,
		// and then doing the subdivide or rejoin as needed. therefore, subdivide and rejoin should be separate, standalone functions!
		
	}

}


</script>


</html>
