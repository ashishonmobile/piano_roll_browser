<!doctype html>

<head>
	<title> piano roll in the browser wow </title>
	<script src='https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js'></script>
	<meta charset='utf-8'>
</head>

<style>
	html{
		font-family: Arial;
	}
	
	table, tr, td{
		border: 1px solid #000;
	}

	#piano{
		display: inline-block;
	}
	
	#wavetypeLabel{
		font-family: 'arial', 'gothic ms';
		font-size: 14px;
		padding-left: 10px;
	}
	
	#title{
		margin: 0;
	}
	
	ul{
		padding: 0;
		margin: 0;
	}
	
	li{
		list-style-type: none;
		display: inline-block;
	}
	
	li h2{
		font-size: 12px;
	}
	
	.footer{
		text-align: center;
		margin-top: 3%;
		font-size: 12px;
		font-family: 'ms gothic';
		border-top: 1px solid #000;
	}
</style>

<body>

<h2 id='title'> piano roll fun ʕ•ᴥ•ʔ</h2>

<div id='toolbar'>

	<ul>
		<li><h2 id='measures'></h2></li>
		<li>|</li>
		<li><h2 id='timeSig'></h2></li>
		<li>|</li>
		<li><h2 id='subdiv'></h2></li>
	</ul>

	<ul>
		<li><button onclick='readInNotes()'> play! </button></li>
		<li><button onclick='stopPlay()'> stop! </button></li>
		<li><button onclick='addNewMeasure()'> add new measure </button></li>
		<li>
			<label id='wavetypeLabel'> wave type:
			<select id='selectWave'>
				<option> sine </option>
				<option> square </option>
				<option> sawtooth </option>
				<option> triangle </option>
			</select>
			</label>
		</li>
	</ul>

</div>

<!-- each instrument will have its own div, which should be one row -->
<br>
<br>

<div class='instrument' id='inst'>
	<table>
		<tr>
			<td> INSTRUMENT 1 </td>
		</tr>
	</table>
</div>

<br>

<!-- create a piano for each instrument -->
<div id='piano'>
	<div id='columnHeaderRow'></div>
</div>


<div class='footer'>
	<p> c.2017 nch works </p>
</div>

</body>

<script>
//references:
//http://jsfiddle.net/remotesynth/73cD5/?utm_source=website&utm_medium=embed&utm_campaign=73cD5
//https://modernweb.com/creating-sound-with-the-web-audio-api-and-oscillators/
//http://www.phy.mtu.edu/~suits/notefreqs.html
//http://stackoverflow.com/questions/1114024/constructors-in-javascript-objects
//http://stackoverflow.com/questions/32239560/web-audio-oscillators-unexpectedly-glide-from-one-frequency-to-another-in-chrome
//http://stackoverflow.com/questions/15261030/web-audio-start-and-stop-oscillator-then-start-it-again
//http://stackoverflow.com/questions/18785951/how-to-get-width-of-a-div-in-percentage-using-jquery
//http://alemangui.github.io/blog//2015/12/26/ramp-to-value.html

//TODO:
/*
-tempo change - currently ~152 bpm!
-allow color customizations for highlight, note blocks
-legato, staccato toggling for individual notes
-bend notes? :>
-multiple instruments => this is gonna be hard because we can't keep adding rows and columns to the DOM => reuse same grid, but store note info!
-onion-skin type thing to show where other instruments' notes are like in PxTone
*/

/**** INFORMATION ABOUT THE CURRENT SETUP ****/
var numberOfMeasures = 4; //4 measures by default
var subdivision = 8; //each measure subdivided by eighth notes
var timeSignature = "4/4";

$('#measures').html("number of measures: " + numberOfMeasures);
$('#timeSig').html("time signature: " + timeSignature);
$('#subdiv').html("subdivision: " + subdivision);

/**** SET UP AUDIO CONTEXT *****/
var context = new AudioContext();

var g = initGain();
var oscillator = initOscillator(g);//context.createOscillator();
g.connect(context.destination); //the hook up gain with audio context

// connect gain object. each oscillator should have its own gain I think.
function initOscillator(g){
	var o = context.createOscillator();
	o.type = $('#selectWave').val();
	o.connect(g); 
	o.start(0);
	return o;
}

function initGain(){
	var g = context.createGain();
	/* set gain to 0 initially so no sound will be heard */
	g.gain.value = 0.0;
	return g;
}

/*****  NOTE CLASS ******/
//this class will hold a note's frequency and duration
//duration is in miliseconds (i.e. 600, 300, 1000) - because using setTimeout to play notes for specified duration
function Note(freq, duration){
	this.freq = freq ? freq : 0.0; //if a value for freq is passed, use it. otherwise 0.
	this.duration = duration ? duration : 0.0;

	this.setFreq = function(value){
		this.freq = value;
	}
	
	this.setDuration = function(value){
		this.duration = value;
	}
	
	this.getFrequency = function(){
		return this.freq;
	}
	
	this.getDuration = function(){
		return this.duration;
	}
}

/* testing 
var n1 = new Note();
n1.setFreq(200);
n1.setDuration(1);
console.log(n1);
var n2 = new Note(250, 2);
console.log(n2);
*/

/***** NECESSARY GLOBAL VARIABLES ******/
var notes = [];
var timer; //holds setTimeout to allow for easy stopping
var currentInstruments = []; //this array will hold all the instruments. each instrument is one oscillator.

// note frequencies @ 440Hz
var noteFrequencies = {
/*
	"C0": 16.35,
	"C#0": 17.32,
	"Db0": 17.32,
	"D0": 18.35,
	"D#0": 19.45,
	"Eb0": 19.45,
	"E0": 20.60,
	"F0": 21.83,
	"F#0": 23.12,
	"Gb0": 23.12,
	"G0": 24.50,
	"G#0": 25.96,
	"Ab0": 25.96,
	"A0": 27.50,
	"A#0": 29.14,
	"Bb0": 29.14,
	"B0": 30.87,
	
	"C1": 32.70,
	"C#1": 34.65,
	"Db1": 34.65,
	"D1": 36.71,
	"D#1": 38.89,
	"Eb1": 38.89,
	"E1": 41.20,
	"F1": 43.65,
	"F#1": 46.25,
	"Gb1": 46.25,
	"G1": 49.00,
	"G#1": 51.91,
	"Ab1": 51.91,
	"A1": 55.00,
	"A#1": 58.27,
	"Bb1": 58.27,
	"B1": 61.74,
*/	
	"C7": 2093.00,
	"B6": 1975.53,
	"Bb6": 1864.66,
	"A#6": 1864.66,
	"A6": 1760.00,
	"Ab6": 1661.22,
	"G#6": 1661.22,
	"G6": 1567.98,
	"Gb6": 1479.98,
	"F#6": 1479.98,
	"F6": 1396.91,
	"E6": 1318.51,
	"Eb6": 1244.51,
	"D#6": 1244.51,
	"D6": 1174.66,
	"Db6": 1108.73,
	"C#6": 1108.73,
	"C6": 1046.50,

	"B5": 987.77,
	"Bb5": 932.33,
	"A#5": 932.33,
	"A5": 880.00,
	"Ab5": 830.61,
	"G#5": 830.61,
	"G5": 783.99,
	"Gb5": 739.99,
	"F#5": 739.99,
	"F5": 698.46,
	"E5": 659.25,
	"Eb5": 622.25,
	"D#5": 622.25,
	"D5": 587.33,
	"Db5": 554.37,
	"C#5": 554.37,
	"C5": 523.25,

	"B4": 493.88,
	"Bb4": 466.16,
	"A#4": 466.16,
	"A4": 440.00,
	"Ab4": 415.30,
	"G#4": 415.30,
	"G4": 392.00,
	"Gb4": 369.99,
	"F#4": 369.99,
	"F4": 349.23,
	"E4": 329.63,
	"Eb4": 311.13,
	"D#4": 311.13,
	"D4": 293.66,
	"Db4": 277.18,
	"C#4": 277.18,
	"C4": 261.63,
	
	"B3": 246.94,
	"Bb3": 233.08,
	"A#3": 233.08,
	"A3": 220.00,
	"Ab3": 207.63,
	"G#3": 207.63,
	"G3": 196.00,
	"Gb3": 185.00,
	"F#3": 185.00,
	"F3": 174.61,
	"E3": 164.81,
	"Eb3": 155.56,
	"D#3": 155.56,
	"D3": 146.83,
	"Db3": 138.59,
	"C#3": 138.59,
	"C3": 130.81,
	
	"B2": 123.47,
	"Bb2": 116.54,
	"A#2": 116.54,
	"A2": 110.00,
	"Ab2": 103.83,
	"G#2": 103.83,
	"G2": 98.00,
	"Gb2": 92.50,
	"F#2": 92.50,
	"F2": 87.31,
	"E2": 82.41,
	"Eb2": 77.78,
	"D#2": 77.78,
	"D2": 73.42,
	"Db2": 69.30,
	"C#2": 69.30,
	"C2": 65.41
};


/***** FUNCTIONALITY ********/
/* 
this function takes an array of notes and an index and plays the note at that index 
with a specific duration.
*/
function readAndPlayNote(array, index){  
	/* when to stop playing */
	if(index === array.length){
		g.gain.value = 0;
	}else{
		oscillator.type = $('#selectWave').val();
		//oscillator.frequency.value = array[index].getFrequency();
		/* tip! by setting value at a certain time, this prevents the 'gliding' from one freq. to the next */
		oscillator.frequency.setValueAtTime(array[index].getFrequency(), 0);
		//by setting gain value here according to the two conditions, this allows for the 'articulation' of notes without 
		//the 'helicopter' sound when a certain note frequency is 0. 
		//previously, the gain would have been .3 even for notes with 0 frequency,
		//which causes some increase in volume in background sound.
		//it was only detectable when I added the setTimeout below where I set gain to 0.
		//this is fixed by always setting gain to 0 if a note's frequency is 0.
		g.gain.value = array[index].getFrequency() > 0 ? .3 : 0.0;
		if(index < array.length){
			//hold the current note for whatever duration was specified
			//in other words, hold this current note for array[index].getDuration(), then move on to the next note.
			//note that index is pre-incremented for the next note, but we also need the duration for this current index!
			//therefore, currIndex will hold the current note's index.
			var currIndex = index;
			
			//change gain to 0 after a really small amount of time to give the impression of articulation
			//100 might have to be a better value later to coordinate with when the next note will play
			setTimeout(function(){ g.gain.value = 0.0; }, 100); 
			
			timer = setTimeout(function(){readAndPlayNote(array, ++index)}, array[currIndex].getDuration()); 
		}
	}
}
/* stop playback */
function stopPlay(){
	clearTimeout(timer);
	g.gain.value = 0.0;
}
/* allows for a note to sound temporarily when user clicks on a block */
function clickNote(id){
	var parent = document.getElementById(id).parentNode.id;
	parent = parent.replace('s', '#'); //replace any 's' with '#' so we can match a key in noteFrequencies
	
	setTimeout(function(){
		oscillator.type = $('#selectWave').val();
		oscillator.frequency.setValueAtTime(noteFrequencies[parent], 0);
		g.gain.value = .3;
		//this setTimeout makes sure the oscillator gets silent again
		setTimeout(function(){
			oscillator.frequency.value = 0.0;
			g.gain.value = 0;
		}, 100);
	}, 10); //use a small value like 10 so it starts "immediately"
}
/* make blocks on grid clickable */
function addNote(id){
	if($('#' + id).css("background-color") === "rgb(0, 178, 0)"){
		$('#' + id).css("background-color", "transparent");
		
		//change hasNote attribute to false (0) in column header
		var headerId = id.substring(id.indexOf("col"));
		var currValue = parseInt(document.getElementById(headerId).getAttribute("hasNote"));
		document.getElementById(headerId).setAttribute("hasNote", --currValue);
		
	}else{
		$('#' + id).css("background-color", "#00B200");
		
		//change hasNote attribute to true (1) in column header
		var headerId = id.substring(id.indexOf("col"));
		var currValue = parseInt(document.getElementById(headerId).getAttribute("hasNote"));
		document.getElementById(headerId).setAttribute("hasNote", ++currValue);
	}
	clickNote(id);
}
/* make a row highlightable on mouse over - easier to see what note a block is*/
function highlightRow(id, color){
	//get id of parent
	var parent = document.getElementById(id).parentNode.id;
	//highlight
	$('#' + parent).css('background-color', color);
}
/* add a new measure */
function addNewMeasure(){

	$('#measures').text( "number of measures: " + (parseInt($('#measures').text().trim().split(' ').reverse()[0]) + 1) );
	
	//find the dummy node for the header columns and insert before that node
	//the new subdivisions of the new measure
	var dummy = $("div[id='columnHeaderRow_dummy']").get()[0];
	var dummyParent = dummy.parentNode;

	// this is important for letting the grid expand horizontally
	dummyParent.parentNode.style.whiteSpace = "nowrap";
	
	//new column headers 
	for(var i = 0; i < subdivision; i++){
		var newHeader = document.createElement('div');
		newHeader.id = "col_" + (numberOfMeasures * subdivision + i); 
		newHeader.style.width = '40px';
		newHeader.style.height = '12px';
		newHeader.style.fontSize = '10px';
		newHeader.style.display = 'inline-block';
		newHeader.style.textAlign = "center";
		
		//0 == false; i.e. does not have a note in the column
		//this attribute should help optimize performance a bit
		newHeader.setAttribute("hasNote", 0); 
		
		newHeader.textContent =  i + 1;
		
		if(i + 1 === subdivision){
			newHeader.style.borderRight = "3px solid #000";
		}else{
			newHeader.style.borderRight = "1px solid #000";
		}
		dummyParent.insertBefore(newHeader, dummy);
	}
	
	//now add new columns for each note
	var noteRows = $('#piano').children().get();
	
	//start at 1 to skip column header row 
	for(var j = 1; j < noteRows.length; j++){
		for(var k = 0; k < subdivision; k++){
			//get the dummy element for this row
			dummy = $("div[id='" + noteRows[j].id + '_dummy' + "']").get()[0];
			var newColumn = document.createElement("div");
			newColumn.id = noteRows[j].id + "col_" + ((numberOfMeasures * subdivision) + k);
			//adjust id if needed
			newColumn.id = replaceSharp(newColumn.id);
			newColumn.style.display = 'inline-block';
			newColumn.style.width = '40px';
			newColumn.style.height = '15px';
			
			if((k + 1) % subdivision == 0){
				newColumn.style.borderRight = "3px solid #000";
			}else{
				newColumn.style.borderRight = "1px solid #000";
			}

			// hook up an event listener to allow for selecting notes on the grid!
			newColumn.addEventListener("click", function(){ addNote(this.id) });
			// allow for highlighting to make it clear which note a block is
			newColumn.addEventListener("mouseenter", function(){ highlightRow(this.id, '#FFFF99') });
			newColumn.addEventListener("mouseleave", function(){ highlightRow(this.id, 'transparent') });
			noteRows[j].insertBefore(newColumn, dummy);
		}
		//adjust width of row 
		noteRows[j].style.width = parseInt(noteRows[j].style.width) + 20 + "%";
	}
	numberOfMeasures++; //increment measure variable
}

/***** PRODUCE THE GRID ********/
/* dynamically produce piano roll */
var thePiano = $('#piano');
var columnHeaderRow = $('#columnHeaderRow');

/* this will provide the headers for each column in the grid (i.e. number for each beat/subbeat) */
for(var i = 0; i < numberOfMeasures * subdivision + 1; i++){
	var columnHeader = document.createElement('div');
	columnHeader.id = "col_" + (i - 1); //the - 1 here is important! 
	columnHeader.style.display = "inline-block";
	
	if(i > 0){
		columnHeader.style.borderRight = "1px solid #000";
		columnHeader.style.textAlign = "center";
		
		if(i < subdivision + 1){
			if(i === subdivision){
				columnHeader.style.borderRight = '3px solid #000';
			}
			columnHeader.textContent = i;
		}else if(i !== numberOfMeasures * subdivision + 1){
			var subdiv = (i % subdivision) === 0 ? subdivision : (i % subdivision);
			if(subdivision === subdiv){
				columnHeader.style.borderRight = '3px solid #000';
			}
			columnHeader.textContent = subdiv; 
		}
	}
	
	if(i === 0){
		columnHeader.style.width = '50px';
		columnHeader.style.height = '12px';
		columnHeader.style.border = '1px solid #000';
	}else{
		columnHeader.style.width = '40px';
		columnHeader.style.height = '12px';
		columnHeader.style.fontSize = '10px';
	}
	
	//0 == false; i.e. does not have a note in the column
	columnHeader.setAttribute("hasNote", 0); 
	
	columnHeaderRow.append(columnHeader);
}
//can't pass in a jquery selected element
appendDummyElement(document.getElementById('columnHeaderRow'));

/******* BUILDING THE GRID ********/
var note;
for(note in noteFrequencies){
	
	note = note;
	
    // ignore enharmonics 
    if(note.substring(0, 2) === "Gb" || note.substring(0, 2) === "Db" ||
	   note.substring(0, 2) === "D#" || note.substring(0, 2) === "G#" ||
	   note.substring(0, 2) === "A#"){
		continue;
	}
	
	//first create new element for new pitch
	var newRow = document.createElement('div');
	newRow.id = replaceSharp(note);
	
	var newRowText = document.createElement('div');
	newRowText.innerHTML = note.substring(0, note.length - 1) + "<sub>" + note[note.length-1] + "</sub>";
	newRowText.style.fontSize = '11px';
	newRowText.style.border = "1px solid #000";
	newRowText.style.display = 'inline-block';
	newRowText.style.width = "50px";
	newRowText.style.verticalAlign = "middle";
	
	newRow.appendChild(newRowText);
	thePiano.append(newRow);
	/* append columns to each row */
	for(var j = 0; j < numberOfMeasures * subdivision; j++){
		var column = document.createElement("div");
		column.id = replaceSharp(note) + "col_" + j;
		column.style.display = 'inline-block';
		//column.style.cssFloat = "left";
		column.style.width = "40px";
		column.style.height = "15px";
		column.style.verticalAlign = "middle";
		
		if((j + 1) % subdivision == 0){
			column.style.borderRight = "3px solid #000";
		}else{
			column.style.borderRight = "1px solid #000";
		}

		// hook up an event listener to allow for picking notes on the grid!
		column.addEventListener("click", function(){ addNote(this.id) });
		// allow for highlighting to make it clear which note a block is
		column.addEventListener("mouseenter", function(){ highlightRow(this.id, '#FFFF99') });
		column.addEventListener("mouseleave", function(){ highlightRow(this.id, 'transparent') });
		newRow.appendChild(column);
	}
	//
	//this was used previously to clear the float lefts when I floated all the grid blocks left.
	//but since they're all now display: inline-block instead, which works much better, this is
	//really an artifact now. 
	appendDummyElement(newRow);
}

/* helper function to replace '#' in string */
function replaceSharp(string){
	//this adjustment is only necessary for labeling the DOM elements so that they're clickable
	//previously, without this adjustment, sometimes you'd get a string id with two '#' chars for the sharp notes,
	//because of how I decided to label my ids. since you also need a # for jQuery selection, adjustment is necessary. 
	if(string.indexOf('#') != -1){
		return string.replace('#', 's'); //s for sharp
	}
	//otherwise do nothing
	return string;
}

function appendDummyElement(elementToAppendTo){
	var dummyElement = document.createElement('div');
	dummyElement.id = elementToAppendTo.id + "_dummy";
	elementToAppendTo.appendChild(dummyElement);
}

/******* GET NOTES AND PLAY ******/
/* now how to figure which beats are rests and which are notes? */
/*
	get an array of all the possible notes for each beat. since subdivision is 8,
	there will 8 beats per measure. so 32 arrays! eeeek!
	- still have to think about tempo also!!!
	
	check each array for a green background. only ONE green allowed per array, for 
	now at least. if green, put as new note in notes array. otherwise, make Note with 0.
	-ok, but how about if I want a quarter note (2 connected blocks)?
	-maybe make an option for placing eigth notes, quarter notes, whole notes,
	(eventually 16th?)
	
	-if placing quarter note, remember to remove borders
	-adjust duration accordingly

*/


/* this will read all the notes and put them in an array */
function readInNotes(){
	notes = [];
	
	//first find what the last column with a note (hasnote === 1) is 
	//this will aid performance and prevent unnecessary column look-throughs 
	var columnHeaders = document.getElementById('columnHeaderRow').children;
	var lastColumn = -1;
	for(var k = 0; k < columnHeaders.length; k++){
		if(columnHeaders[k].getAttribute('hasnote') === '1'){
			lastColumn = parseInt(columnHeaders[k].id.substring(4));
		}
	}
	
	// gather each column
	for(var i = 0; i <= lastColumn; i++){
		
		var column = $("div[id$='col_" + i + "']").get(); //get all the blocks in each column
		var found = 0;
		for(var j = 0; j < column.length; j++){
			// look for green background! 
			if(column[j].style.backgroundColor === "rgb(0, 178, 0)"){
				//console.log("found!!");
				found = 1;
				//make any corrections to id string before matching with freq key
				var freq = noteFrequencies[ (column[j].parentNode.id).replace('s', '#') ];
				notes.push(new Note(freq, 200));
				break;
			}
		}
		if(found === 0){
			notes.push(new Note(0.0, 200)); //200 ms per eight note for now
		}
	}
	//console.log(notes);
	readAndPlayNote(notes, 0);
}

</script>


</html>
